<!DOCTYPE html>
<html>
  <head>
    <title>SocketCluster</title>
    <link rel="icon" type="image/png" href="/favicon.ico">
    <script type="text/javascript" src="/socketcluster.js"></script>
  </head>
  <body>
    <div id="container">    
    </div>
    <input type="text" id="create" placeholder="title"/>
    <script type="text/javascript">
      var email = 'user@email.com';
      var socket = socketCluster.connect();

      socket.on('error', function (err) {
        console.error(err);
      });
      //socket.on('connect', function () {
        function addMessage(msg) {
          console.log('adding message', msg);
          var elt = document.createElement("li"); 
          var content = document.createTextNode(msg.body); 
          elt.appendChild(content);
          document.getElementById('thread-' + msg.threadId).appendChild(elt);
        }

        function addThread(tid, title) {
          var chatChannel = socket.subscribe('chat-' + tid);

          chatChannel.watch(addMessage);

          chatChannel.on('subscribe', function () { 
            var content = '<div> \
              <h3>' + title + '</h3> \
                <ul id="thread-' + tid + '"></ul> \
                <input id="input-' + tid + '" type="text"/> \
              </div>';
            var elt = document.createElement("div"); 
            elt.innerHTML = content; 
            document.getElementById('container').appendChild(elt);
            document.getElementById('input-' + tid).onkeypress = function(evt) {
              if (evt.keyCode === 13) {
                var msg = {
                  user: email,
                  body: evt.target.value,
                  threadId: tid
                };
                socket.emit('chat', msg, function (err, msgs) {
                  if (err) {
                    console.error(err);
                    return;
                  }
                  evt.target.value = '';
                });
              }
            }
            socket.emit('thread', tid, function (err, msgs) {
              if (err) {
                console.error(err);
                return;
              }
              for (var i = 0; i < msgs.length; i++) {
                msgs[i].threadId = tid;
                addMessage(msgs[i]);
              }
            });
          });  
        }

        var personalChannel = socket.subscribe(email);
        personalChannel.watch(addThread);

        personalChannel.on('subscribe', function () {
          socket.emit('threads', email, function (err, threads) {
            for (var i = 0; i < threads.length; i++) {
              addThread(threads[i]._id, threads[i].title);
            }
            document.getElementById('create').onkeypress = function(evt) {
              if (evt.keyCode === 13) {
                socket.emit('new', {title: evt.target.value, user: email}, function (err, thread) {
                  if (err) {
                    console.error(err);
                    return;
                  }
                  addThread(thread._id, thread.title);
                  evt.target.value = '';
                });
              }
            }
          });
        });
      //});
    </script>
  </body>
</html>
